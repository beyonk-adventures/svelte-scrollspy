<div ref:container>
	<slot></slot>
</div>

<script>
	export default {
		data () {
			return {
				visible: []
			}
		},

		oncreate () {
			const sectionElements = [].slice.call(this.refs.container.querySelectorAll('.scrollable-section'))
			this.set({ sections: sectionElements.map(s => s.id) })

			const io = new IntersectionObserver(entries => {
				let { visible, sections } = this.get()
				
				entries.forEach(e => {
					const id = e.target.id
					if (e.isIntersecting) {
						const op = sections.indexOf(id) < sections.indexOf(visible[0]) ? 'unshift' : 'push'
						visible[op](id)
					} else {
						const visiblePosition = visible.indexOf(id)
						visiblePosition > -1 && visible.splice(visiblePosition, 1)
					}
				})

				this.set({ visible, activeSectionId: visible[0] })
			}, { threshold: [ 1 ] })

			sectionElements.forEach(el => {
				io.observe(el)
			})

			this.set({ io })
		},

		ondestroy () {
			const { io } = this.get()
			io.disconnect()
		}
	}
</script>